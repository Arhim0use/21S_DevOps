# DO2_LinuxNetwork 
## Сети Адресация Маршрутизация NAT


  1 [Инструмент ipcalc](#part-1-инструмент-ipcalc)\
    - 1.1 [Сети и маски](#11-сети-и-маскиpart)\
    - 1.2 [localhost](#12-localhost)\
    - 1.3 [Диапазоны и сегменты сетей](#13-диапазоны-и-сегменты-сетей)\
  2 [Статическая маршрутизация между двумя машинами](#part-2-cтатическая-маршрутизация-между-двумя-машинами)\
    - 2.1 [Добаяем статический маршрут вручную](#21-добаяем-статический-маршрут-вручную)\
    - 2.2 [Добаяем статический маршрут с сохранением](#22-добаяем-статический-маршрут-с-сохранением)\
  3 [Утилита iperf3](#part-3-утилита-iperf3)\
    - 3.1 [Скорость соединения](#31-скорость-соединения)\
  4 [Сетевой экран](#part-4-сетевой-экран)\
    - 4.1 [Утилита iptables](#41-утилита-iptables)\
    - 4.2 [Утилита nmap](#42-утилита-nmap)\
  5 [Статическая маршрутизация сети](#part-5-статическая-маршрутизация-сети)\
    - 5.1 [Настройка адресов машин](#51-настройка-адресов-машин)\
    - 5.2 [Включение переадресации IP-адресов](#52-включение-переадресации-ip-адресов)\
    - 5.3 [Установка маршрута по-умолчанию](#53-установка-маршрута-по-умолчанию)\
    - 5.4 [Добавление статических маршрутов](#54-добавление-статических-маршрутов)\
    - 5.5 [Построение списка маршрутизаторов](#55-построение-списка-маршрутизаторов)\
    - 5.6 [Использование протокола ICMP при маршрутизации](#56-использование-протокола-icmp-при-маршрутизации)\
  6 [Динамическая настройка IP с помощью DHCP](#part-6-динамическая-настройка-IP-с-помощью-DHCP)\
  7 [NAT](#part-7-nat)\
  8 [SSH Tunnels](#part-8-ssh-tunnels)\

### Part 1 Инструмент ipcalc

  `ipcalc` - Команда в Linux используется для выполнения простых манипуляций с IP-адресами, таких как вычисление диапазона хостов, широковещательной рассылки, сети и маски подстановочных знаков cisco. Он принимает сетевую маску и IPv4-адрес и возвращает полную информацию об IP-адресе хоста.
#### 1.1 Сети и маски
  ![Install_ipcalc](img/002-Install_ipcalc.png) 
  ![ipcalc_192.167.38.54/13](img/003-Ipcalc_usage.png)
  Адрес сети `192.167.38.54/13` = `11000000.10100111.00100110.001110110` 

<details>  <summary> 
  Вычисление маски по таблице.  </summary> 

  ![vychislenie_maski](img/004-vychislenie_maski.png)
</details>

  Перевод маски сети 255.255.255.0: 
  1. Двоичная маска 11111111.11111111.11111111.00000000
  2. Префиксная маска /24  \
  ![ipcalc_255.255.255.0](img/005-ipcalc_mask.png)

  Перевод маски сети /15: 
  1. Двоичная маска 11111111.11111110.00000000.00000000
  2. Десятичная маска 255.254.0.0 \
  ![ipcalc_/15](img/006-ipcalc_prefix.png)
  

  Перевод маски сети 11111111.11111111.11111111.11110000: 
  1. Префиксная маска /28
  2. Десятичная маска 255.255.255.240 \
  ![ipcalc_bynary](img/007-ipcalc_bynary.png)

  Хост в сети 12.167.38.4:
  1. При маске /8: \
    - Минимальный 12.0.0.1 \
    - Максимальный 12.255.255.254
  ![12.167.38.4/8](img/008-ipcalc_min_max_host_mask8.png)
  2. При маске 11111111.11111111.0.0: \
    - Минимальный  12.167.0.1 \
    - Максимальный 12.167.255.254 \
  ![12.167.38.4/255.255.0.0](img/009-ipcalc_min_max_host_mask_255_255_0_.png)
  3. При маске 255.255.254.0: \
    - Минимальный  12.167.38.1 \
    - Максимальный 12.167.39.254 \
  ![12.167.38.4/255.255.254.0](img/010-ipcalc_min_max_host_mask_255_255_254_0.png)
  4. При маске /4: \
    - Минимальный  0.0.0.1 \
    - Максимальный 15.255.255.255 \
  ![12.167.38.4/4](img/011-ipcalc_min_max_host_mask_4.png)

#### 1.2 localhost
  Можно ли обратиться к приложению, работающему на localhost, со следующими IP: 
  - 194.34.23.100 - нет 
  - 127.0.0.2 - да
  - 127.1.0.1 - да 
  - 128.0.0.1 - нет \
  ![localhost](img/012-ipcalc_localhost.png)
#### 1.3 диапазоны и сегменты сетей 
  Под частные сетевые диапазоны выделены:
  - 10.0.0.0 — 10.255.255.255 (маска подсети для бесклассовой адресации: 255.0.0.0 или /8);
  - 100.64.0.0 — 100.127.255.255 (маска подсети 255.192.0.0 или /10);
  - 172.16.0.0 — 172.31.255.255 (маска подсети: 255.240.0.0 или /12);
  - 192.168.0.0 — 192.168.255.255 (маска подсети: 255.255.0.0 или /16).
  Сравнить вручную первые два диапазона сети или проверить строчку Hosts/Net  команды `ipcalc`

  ![ip_private_public](img/013-ipcalc_ip_class.png)
  Какие из перечисленных IP можно использовать в качестве публичного, а какие только в качестве частных: 
  - 10.0.0.45 - Частный адрес
  - 134.43.0.2 - Публичный адрес
  - 192.168.4.2 - Частный адрес
  - 172.20.250.4 - Частный адрес 
  - 172.0.2.1 - Публичный адрес
  - 192.172.0.1 - Публичный адрес
  - 172.68.0.2 - Публичный адрес
  - 172.16.255.255 - Частный адрес
  - 10.10.10.10 - Частный адрес
  - 192.169.168.1 - Публичный адрес

 Какие из перечисленных IP адресов шлюза возможны у сети 10.10.0.0/18:\
 ![ip_gateway](img/014-ipcalc_gateway.png)
 (доступный диапазон 10.10.0.1 - 10.10.63.254)
 - 10.0.0.1 - не возможен 
 - 10.10.0.2 - возможен 
 - 10.10.10.10 - возможен 
 - 10.10.100.1 - не возможен 
 - 10.10.1.255 - возможен

### Part 2 Статическая маршрутизация между двумя машинами
<details>  <summary> 
  Создание виртуальных машин.  </summary> 

 ![Inicializaton_virtual_machines](img/001-VirtualBox.png) 
</details>

 ![network_interface](img/015-ip_a_network_interface.png)

  Включаем дополнительные адаптеры в Virtual-Box что бы не потерять подключение в интернет.
  
  Задаем новые статические адреса для виртуальных машин: 
  - ws1 192.168.100.10/16 \
 ![ws_1_netplan](img/016-ws1_static_ip.png)
  - ws2 172.24.116.8/12 \
 ![ws_2_netplan](img/017-ws2_static_ip.png)

#### 2.1. Добаяем статический маршрут вручную
  Соединяем машины по ip и пингуем соединение: \
  ![ws_1_ip_route_add](img/018-ws1_static_connect.png)
  ![ws_2_ip_route_add](img/019-ws2_static_connect.png)
  ![ws1_ping_ws2](img/020-ws1_ping_ip_ws2.png)
  ![ws2_ping_ws1](img/021-ws2_ping_ip_ws1.png)
  *Соединение установлено, все пакеты между машинами передаются*

#### 2.2. Добаяем статический маршрут с сохранением
  Перезпускаем машины. \
  ![ws1_reboot](img/022-ws1_reboot.png)
  ![ws2_reboot](img/023-ws2_reboot.png)
  Статическое соедининеие было разорвано.
  ![ws1_ping_ws2_fail](img/024-ws1_ping_ip_ws2_fail.png)

  Меняем кофиг файл `/etc/netplan/00-installer-config.yaml` что бы при перезапуске настройки соединения сохранялись и проверяем соединение.
  ![ws1_route_config](img/025-ws1_routes_config.png)
  ![ws2_route_config](img/026-ws2_routes_config.png)

### Part 3 Утилита iperf3

  `iperf3`  - консольная клиент-серверная утилита — генератор TCP и UDP трафика для тестирования пропускной способности сети.  

#### 3.1. Скорость соединения
  Конвертировать:

|From    | To  |
|--------|-----|
|8 Mbps  | 1 MB/s|
|100 MB/s| 800000 Kbps|
|1 Gbps  | 1000 Mbps  |

*Mbps (мегабит в секунду) - это мера скорости передачи данных, используемая для оценки пропускной способности сети и скорости интернет-соединений.* \
*MB/s (мегабайт в секунду) - это мера скорости передачи данных, используется в контексте объема данных, передаваемых или записываемых за секунду на устройства хранения данных, такие как жесткие диски, SSD или флеш-накопители.*  \
*В одном мегабайте 8 мегабит.*

#### Part 3.1 Утилита iperf3

На машине ws1 запускаем утилиту через команду `iperf3 -s`, она будет выступать в роли сервера и просушиать соединения.

![ws1_iperf_-s](img/027-ws1_iperf3_serv.png)

На машине ws2 подключаемся к первой машине и производим замер скорости с помошью команды `iperf3 -c 192.168.100.10 -f m`
![ws1_iperf_after_connect](img/029-ws1_iperf3_connect.png)
![ws2_iperf_-c](img/028-ws2_iperf3_connect.png)

Где флаг `-f` или `--format` означает формат вывода данных

 | | |
 |----|----|
 | k | kbps|
 | m | mbps|
 | g | gbps|
 | t | tbps|
 | K | KB/s|
 | M | MB/s|
 | G | GB/s|
 | T | TB/s|
 
Столбцы вывода сервера:
 - ID: Уникальный идентификатор соединения.
 - Interval: Временной интервал, для которого показываются данные.
 - Transfer: Объем данных, который был принят сервером за указанный интервал.
 - Bitrate: Средняя скорость передачи данных, здесь выраженная в гигабитах в секунду.
 
Столбцы вывода клиента:
 - ID: Уникальный идентификатор соединения.
 - Interval: Временной интервал, в течение которого производились замеры, выраженный в секундах.
 - Transfer: Объём данных, переданных за время интервала.
 - Bitrate: Средняя пропускная способность за время интервала, выраженная в мегабайтах в секунду (MBytes/sec).
 - Retr: Количество повторных передач (retransmissions), которые пришлось совершить из-за потери пакетов.
 - Cwnd (Congestion Window): Размер окна перегрузки в мегабайтах, который контролирует количество байт, которые могут быть отправлены без подтверждения приема.

### Part 4 Сетевой экран
#### 4.1 Утилита iptables


`iptables` - инструмент управления сетью в Linux, который позволяет администраторам управлять входящими и исходящими пакетами данных на основе набора правил, которые определяют, как обрабатывать различные виды трафика.

Создаём файл /etc/firewall.sh, имитирующий фаерволл, на машинах ws1 и ws2, и ему даем права на исполнение *(`x` - Execute)* командой `chmod +x /etc/firewall.sh` 

![ws1_itables_config](img/030-ws1_iptables_firewall.png)
![ws2_itables_config](img/031-ws2_iptables_firewall.png)

После исполнения файла пытаемся проверить связь между машинами командой `ping "ip address"`.

Результат, первая машина получает ответы от второй, а вторая от первой нет. Это обьясняется тем что команда которая идет раньше имеет больший приоритет чем последущая команда. При отправке запросов и проверке фильтров сети первое правило встречается раньше второго и прерывает дальнейшую проверку правил.  

#### 4.2 Утилита nmap

`nmap` *(network mapper)* - это утилита, предназначенная для разнообразного настраиваемого сканирования IP-сетей с любым количеством объектов, определения состояния объектов сканируемой сети (портов и соответствующих им служб). Может быть использован для проверки безопасности, просто для определения сервисов запущенных на узле, для идентификации ОС и приложений, определения типа фаерволла используемого на сканируемом узле.

В предыдущем скриншоте мы увидели что машина ws1 не пингуется, но это еще не значит что у неё запрет на ответ, может она выключена. Еще раз пингуем адресс 192.168.100.10. А теперь проверяем командой `nmap -sP 192.168.100.10` запущен ли хост по этому адрессу.

`-sP`- Пинг сканирование - флаг позволяет определить, работает ли хост.

![ws2_nmap_scanning](img/032-ws2_nmap.png)
*Host is up - машина ws1 включена*

### Part 5 Статическая маршрутизация сети
Поднимамаем пять виртуальных машин (3 рабочие станции (ws11, ws21, ws22) и 2 роутера (r1, r2)).
![virtualbox_5_vm](img/033-virtualbox_5_new_machines.png)
*Вкючаем дополнительные порты для соединения машин, для роутеров дополнительно еще один для соединения их между собой*
#### 5.1. Настройка адресов машин
Прописываем конфигурацию сети для роутеров.
![r1_netplan_config](img/034-r1_netplan_config_address.png)
![r2_netplan_config](img/035-r2_netplan_config_address.png)

Применяем настройки и проверяем их соединение между собой.
![r1_ping_r2](img/036-r1_ping_r2.png)
![r2_ping_r1](img/037-r2_ping_r1.png)

Проверяем командой `ip -4` a проверь, что адрес машин задан верно. 
![r1_network](img/038-r1_network.png)
![r2_network](img/039-r2_network.png)

Прописываем конфигурацию сети для рабочих станций.
![ws11_netplan_config](img/040-ws11_netplan_config_address.png)
![ws21_netplan_config](img/041-ws21_netplan_config_address.png)
![ws22_netplan_config](img/042-ws22_netplan_config_address.png)

Применяем настройки для ws11 и проверяем соединение с роутером.
![r1_ping_ws11](img/043-r1_ping_ws11.png)
![ws11_ping_r1](img/044-ws11_ping_r1.png)

Применяем настройки для ws21 и ws22 и проверяем соединение между ними и роутером.
![r2_ping_ws21_and_ws22](img/045-ping_from_r2.png)
![ws21_ping_r2_and_ws22](img/046-ping_from_ws21.png)
![ws22_ping_r2_and_ws21](img/047-ping_from_ws22.png)

#### 5.2. Включение переадресации IP-адресов.

Для переадресации IP-адрессов на роутерах включаем её командой `sysctl -w net.ipv4.ip_forward=1`. Такой способ будет работать до перезагрузки роутера.
![r1_ip_forward](img/048-r1_ip_forward.png)
![r2_ip_forward](img/049-r2_ip_forward.png)

Для постоянной переадресации расскоментируем строку `net.ipv4.ip_forward = 1` в файле конфиграции `/etc/sysctl.conf`
![r1_ip_forward_config_file](img/050-r1_ip_forward_conf.png)
![r2_ip_forward_config_file](img/051-r2_ip_forward_conf.png)

#### 5.3. Установка маршрута по-умолчанию

Теперь настрем маршрут по-умолчанию (шлюз) для рабочих станций.\
*Основной шлюз (установленный по умолчанию, default gateway) — является главным, он обрабатывает все пакеты данных, которые отправляются узлом за пределы его локальной сети в интернет или просто в другую подсеть. Т.е. если ПК не знает куда отправлять пакеты данных, то он обращается к основному сетевому шлюзу. (не знает, это значит нет подключенного маршрута или более точного)*\
Командой `ip r` посмотрим текущие настройки маршрутов на машинах.
![r1_routes_before_changing](img/052-r1_ip_routes_before.png)
![r2_routes_before_changing](img/053-r2_ip_routes_before.png)
![ws11_routes_before_changing](img/054-ws11_ip_routes_before.png)
![ws21_routes_before_changing](img/055-ws21_ip_routes_before.png)
![ws22_routes_before_changing](img/056-ws22_ip_routes_before.png)

Меняем файл конфигурации `etc/netplan/00-installer-config.yaml.` на машинах.

Дефолный маршрут для рабочей машины №11
![ws11_default_route](img/057-ws11_netplan_default_route.png)
![ws11_ip_routes_after](img/058-ws11_ip_routes_.png)

Дефолный маршрут для рабочей машины №21
![ws21_default_route](img/061-ws21_netplan_default_route.png)
![ws21_ip_routes_after](img/063-ws21_ip_routes_.png)

Дефолный маршрут для рабочей машины №22
![ws22_default_route](img/062-ws22_netplan_default_route.png)
![ws22_ip_routes_after](img/064-ws22_ip_routes.png)

Рабочая машина отправляет сигнал на роутер 2 и он доходит, но не получает ответа о достигнутом сигнале.
![ws11_ping_r2](img/059-ws11_ping_r2.png)
![r2_listens_ping_from_ws11](img/060-r2_tcpdump_echo_from_ws11.png)

`tcpdump` - это утилита UNIX (есть клон для Windows), позволяющая перехватывать и анализировать сетевой трафик, проходящий через компьютер, на котором запущена данная программа. Утилита tcpdump позволяет проверять заголовки пакетов TCP/IP и выводить одну строку для каждого из пакетов.

`-i` - Указывает на то, какой сетевой интерфейс будет использоваться для захвата пакетов. По умолчанию — eth0, для выбора всех интерфейсов — any. Если отсутствует локальная сеть, то можно воспользоваться интерфейсом обратной связи lo.\
`-t` - Не отображает метку времени в каждой строке.\
`-n` - Отображает IP-адрес вместо имени хоста. Без этого флага tcpdump пытается разрешить численные IP-адреса и номера портов в соответствующие доменные имена и имена сервисов, что может замедлить отображение данных.

#### 5.4. Добавление статических маршрутов
Прописываем статические маршруты в роутерах
![r1_static_route](img/065-r1_netpaln_static_route.png)
![r2_static_route](img/066-r2_netpaln_static_route.png)

Измененные маршуруты теперь выглядят так:
![r1_routes](img/067-r1_ip_routes_after.png)
![r2_routes](img/068-r2_ip_routes_after.png)

Маршрут по умолчанию выбирается только в том случае, если нет других маршрутов, заданных вручную. При наличии нескольких маршрутов, выбирается тот у которого больше значение маски подсети, а значит адрес с маской 0 не будет выбран, если есть другой.
![ws11_ip_r_list](img/069-ws11_ip_routes_list.png)

#### 5.5. Построение списка маршрутизаторов
При помощи утитлиты `traceroute` мы видим весь путь пакетов от ws11 до машины ws21. А утилита `tcpdump` нам показывает весь путь пакета от одной машины до другой.
![ws11_traceroute_to_ws21](img/070-ws11_traceroute_to_ws21.png)
![r1_tcpdump_route_to_ws21](img/072-r1_tcpdump_listen_ping_ws21.png)

Если добавить флаг `-v` то можно увидеть подробную информацию из заголовка tcp пакета например:
**ttl** - время жизни пакета *1 - означает что будет уничтожен после первого хопа*
**id** - индефикатор пакета
**offset** - смещение фрагмента в пакете
**proto** - протокол передачи данных
**lenght** - длинна пакета в байтах

Так же из передыдущего скриншота мы видем *ARP* запросы и ответы которые подтвержают нормальную работу сети
![r1_tcpdump_verbose_route_to_ws21](img/071-r1_tcpdump_listen_ping_verbose_ws21.png)
#### 5.6. Использование протокола ICMP при маршрутизации
А теперь попробуем пропинговать неизвестный нашей локальной сети ip.\
Запросы проходят через роутер 1 но ответа мы не получаем.
![ws11_ping_nonexist_ip](img/073-ws11_ping_non_existent_ip.png)
![r1_tcpdump_listen_unricheble](img/074-r1_listen_unreacheble.png)

### Part 6 Динамическая настройка IP с помощью DHCP
Теперь попробуем настроить автоматизацию через службу DHCP.
Создаем файл конфигурации /etc/dhcp/dhcpd.conf
![r2_dhcp_configuration](img/075-r2_dhcpd_config.png)
И меняем nameserver в файле `/etc/resolv.conf` 
![r2_resolv_conf](img/076-r2_resolv_config_nameserver.png)
Разрешаем автозапуск сервиса командой `systemctl enable isc-dhcp-server`.\
Перезагружаем настройки DHCP сервера `systemctl restart isc-dhcp-server`
![r2_dhcp_restart](img/077-r2_restart_dhcp_config.png)

Перезагружаем ws21, видим что адрес не поменялся
![ws21_reboot_ip_a](img/078-ws21_reboot_first.png)
Включаем dhcp на втором интерфейсе и перезагружаем еще раз
![ws21_dhcp_on](img/079-ws21_netplan_dhcp_on.png)
![ws21_reboot_ip_a](img/080-ws22_reboot_second.png)
Теперь IP адрес был выдан автоматически.

Делаем тоже самое для машины ws22 и пингуем её с машины ws 21
![ws22_dhcp_on](img/081-ws22_netplan_dhcp_on.png)
![ws22_reboot_ip_a](img/082-ws21_reboot.png)
![ws21_ping_ws22](img/083-ws21_ping_ws22.png)

Прописываем вручную МАС-адресс для машины ws11 и так же включаем DHCP сервис в файле конфигурации *etc/netplan/00-installer-config.yaml* 
![ws11_mac_address](img/084-ws11_mac_address.png)
![ws11_netplan_apply](img/085-ws11_netplan_apply.png)
Тоже самое не забываем сделать в настройках сети виртуальной машины.
![ws11_vb_mac_address](img/088-ws21_hard_mac_address.png)

На роутере r1 прописываем настройки для этой подстеи с жесткой привязкой к mac-адресу машины ws11.\
![r1_dhcpd_config](img/086-r1_dhcpd_conf.png)

Перезагружаем машину и проверяем что МАС-адрес сохранился и нам выдали тот ip-адрес который был прописн в файле конфигурации DHCP-сервиса */etc/dhcp/dhcpd.conf* на роутере r1.
![ws11_ip_a_check_new_ip](img/089-ws11_ip_a.png)
Пингуем роутер
![ws11_ping_r1](img/090-ws11_ping_r1.png)

А для машины ws21 попробуем запросить новый ip-адрес, для этого проверим текущий адресс командой `ip -4 a` и сбросим настройки dhcp-сервиса для порта *enp0s8* командой `dhclient -r enp0s8`
![ws21_dhcp_stop_ip_lease](img/091-ws21-dhcp_stop_lease_ip.png)
Обновим ip сделав широковещательный запрос в сеть командой `dhclient` и снова проверим адрес 
![ws21_dhcp_new_ip](img/092-ws21-dhcp_new_ip.png)

### Part 7 NAT

Для начала выполнения этого задания загружаем ПО для работы с Apache2 сервером командой `apt install apache2`.\
Далее в файле /etc/apache2/ports.conf на ws22 и r1 изменям строку Listen 80 на Listen 0.0.0.0:80, то есть делаем сервер Apache2 общедоступным.
![ws22_apache2_ports_conf](img/093-ws22_apache2_conf.png)
![r2_apache2_ports_conf](img/094-r2_apache2_conf.png)
И запускаем веб-сервер Apache командой `service apache2 start` на машине ws22 и роутере r1
![ws22_start_apache2](img/095-ws22_apache2_start.png)
![r2_start_apache2](img/096-r2_apache2_start.png)

Создаем фаервол аналогично фаерволу из [Части 4](#part-4-сетевой-экран) фаервол на роутере r2 и запускаем его
![r2_firewall_config](img/097-r2_firewall.png)
![r2_firewall_start](img/098-r2_firewall_start.png)
На машине ws22 пингуем роутер r1 и видим что он не пингуется из-за настроек фаервола
![ws22_ping_r1_drop](img/099-ws22_ping_r1.png)

Дописываем правило которое разрешит маршрутизацию всех пакетов протокола ICMP и еще раз запускаем файл фаервола
![r2_icmp_accept](img/100-r2_firewall_icmp_accept.png)
Теперь у нас получается пинггануть роутер r1
![ws22_ping_r1_accept](img/101-ws22_ping_r1.png)

Добавляем еще парочку правил. Включаем SNAT - маскировку всех локальных ip из локальной сети 10.20.0.0. 
![r2_snat_masquarede](img/102-r2_firewal_snat_masquarede.png)
И Включаем DNAT на 8080 порт машины r2 и добавить к веб-серверу Apache доступ из внешней сети
![r2_dnat_port_80](img/103-r2_firewall_dnat_port_8080.png)

`iptables -A FORWARD -p tcp --dport 80 -j ACCEPT` - Разрешаем входящие пакеты в 80 порту по tcp протоколу\
`iptables -A FORWARD -m state --state ESTABLISHED -j ACCEPT` - Разрешаем установленные и связвнные соединения\
`iptables -A FORWARD -i enp0s9 -o enp0s8 -j ACCEPT` - Даем доступ к передаче пакетов от одного порта к другому/
`iptables -t nat --append POSTROUTING -s 10.20.0.0/26 -o enp0s9 -j MASQUERADE` - Маскеруем все исходящие запросы из сети **10.20.0.0/26** по протоколу SNAT\
`iptables -t nat --append PREROUTING  --protocol tcp --dport 8080 -j DNAT --to-destination 10.20.0.3:80` - Перенаправляем входящие запросы на порт **8080** на адрес **10.20.0.3**, *Если вы хотите что бы запросы перенаправлялись на одну и ту же машину, стоит настроить для неё статический ip-адрес*.

*Перед тестированием рекомендуется отключить сетевой интерфейс NAT (его наличие можно проверить командой ip a) в VirtualBox, если он включен*

Командой `telnet [адрес] [порт]` проверяем соединение по TCP для SNAT сначала от машины ws22 до роутера r1 потом наоборот от роутера r1 до машины ws22 \
![ws22_telnet_r1](img/105-ws22_telnet_tcp_connect_r1.png)
![r1_telnet_ws22](img/104-r1_telnet_tcp_coonect_ws22.png)
### Part 8 SSH Tunnels

Для выполнения этого задания мы используем те же настройки фаервола что и для [Part 7](#part-7-nat)
![r2_dnat_port_80](img/103-r2_firewall_dnat_port_8080.png)

В файле */et/apache2/ports.conf* меняем строку `Listen 80` на `Listen localhost:80`
![ws22_apache_ports](img/106-ws22_apache_ports.png)

Для локального подключения Local TCP forwarding с ws21 до ws22 используем команды `ssh 10.20.0.3` на машине ws21
![ws21_local_forwarding_ws22](img/107-ws21_ssh_local_forwarding_ws22.png)

Для удаленного подключения Remote TCP forwarding до ws11 с ws22 используем команду `` на машине ws22
![ws22_remote_forwarding](img/108-ws22_ssh_remote_forward_ws11.png)
![ws22_telnet_localhost](img/109-ws22_telnet_localhost.png)
![ws11_telnet_localhost](img/110-ws11_telnet_localhost_80.png)
